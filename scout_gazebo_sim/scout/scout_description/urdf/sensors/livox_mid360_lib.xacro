


<robot xmlns:xacro="http://ros.org/wiki/xacro">
  <!--
    AuToGo_robot_sim — Livox Mid-360 Xacro
    Author: Ziyang Chen (2025)
    License: Apache-2.0 (see repository LICENSE)

    Notes:
    - 本文件为 AuToGo 自主编写的 Livox Mid-360 传感器集成。
    - 插件使用 livox_laser_simulation 提供的 Gazebo 插件。
    - 仅在传感器 link 上挂载插件，外壳与传感器 link 分离，便于 TF/可视化。
  -->
  <!-- ========= 公用 =========== -->
  <xacro:macro name="null_inertial">
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </xacro:macro>

  <!-- ========= 低层：挂 Livox 插件的传感器宏（不实例化 link/joint） =========== -->
  <xacro:macro name="Livox_Mid_gazebo_sensor"
               params="
                 link_name
                 visualize:=true
                 update_rate:=10
                 resolution:=0.002
                 noise_mean:=0.0
                 noise_stddev:=0.01
                 ros_topic:=/livox/point_cloud
                 samples:=24000
                 downsample:=1
                 csv_file_name">
    <gazebo reference="${link_name}">
      <sensor type="ray" name="${link_name}">
        <pose>0 0 0 0 0 0</pose>
        <visualize>${visualize}</visualize>
        <update_rate>${update_rate}</update_rate>

        <!-- 仅供可视化的 Ray 配置（角度范围可按需要调整） -->
        <plugin name="gazebo_ros_laser_controller" filename="liblivox_laser_simulation.so">
			  <ray>
			  <scan>
				  <horizontal>
				    <samples>100</samples>
				    <resolution>1</resolution>
				    <min_angle>-3.1415926535897931</min_angle>
            <max_angle>3.1415926535897931</max_angle>
				  </horizontal>
				  <vertical>
				    <samples>50</samples>
				    <resolution>1</resolution>
				    <min_angle>-3.1415926535897931</min_angle>
            <max_angle>3.1415926535897931</max_angle>
				  </vertical>
			  </scan>
			  <range>
				  <min>0.1</min>
				  <max>40</max>
				  <resolution>1</resolution>
			  </range>
			  <noise>
				  <type>gaussian</type>
				  <mean>0.0</mean>
				  <stddev>0.0</stddev>
			  </noise>
			  </ray>
          <visualize>False</visualize>
		      <!-- <samples>${samples}</samples> -->
          <samples>20000</samples>
		      <downsample>1</downsample>
		      <!-- <csv_file_name>${downsample}</csv_file_name> -->
          <csv_file_name>package://livox_laser_simulation/scan_mode/mid360-real-centr.csv</csv_file_name>
          <publish_pointcloud_type>3</publish_pointcloud_type>
		      <ros_topic>/livox/lidar</ros_topic>
          <frameName>${link_name}</frameName>
        </plugin>


        
      </sensor>
    </gazebo>
  </xacro:macro>

  <!-- ========= 顶层：真正供外部调用的“库化”宏（创建 link 并挂传感器） =========== -->
  <xacro:macro name="Livox_Mid40"
               params="
                 parent_link:=base_link
                 name:=livox
                 xyz:='0 0 0.14'
                 rpy:='0 0 0'
                 visualize:=true
                 ros_topic:=/livox/point_cloud
                 csv_file_name
                 update_rate:=10
                 resolution:=0.002
                 noise_mean:=0.0
                 noise_stddev:=0.01
                 samples:=24000
                 downsample:=1">

    <!-- 外壳（用于可视/碰撞），独立于传感器 link -->
    <link name="${name}_base">
      <xacro:null_inertial/>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://livox_laser_simulation/meshes/livox_mid-360-90x.dae"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://livox_laser_simulation/meshes/livox_mid-360-90x.dae"/>
        </geometry>
      </collision>
    </link>

    <link name="${name}_sensor">
      <xacro:null_inertial/>
    </link>

    <joint name="${name}_base_mount" type="fixed">
      <parent link="${parent_link}"/>
      <child  link="${name}_base"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <joint name="${name}_to_base" type="fixed">
      <parent link="${name}_base"/>
      <child  link="${name}_sensor"/>
      <origin xyz="0.0 0.0 0.05" rpy="0 0 0"/>
      <!-- <origin xyz="0.0 0.0 0.0" rpy="0 0 0"/> -->

    </joint>

    <!-- 在传感器 link 上挂 livox 插件 -->
    <xacro:Livox_Mid_gazebo_sensor
        link_name="${name}_sensor"
        visualize="${visualize}"
        update_rate="${update_rate}"
        resolution="${resolution}"
        noise_mean="${noise_mean}"
        noise_stddev="${noise_stddev}"
        ros_topic="${ros_topic}"
        samples="${samples}"
        downsample="${downsample}"
        csv_file_name="${csv_file_name}"/>
  </xacro:macro>

</robot>
